<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Justpresso Config Web Server">
    <title>Justpresso</title>
    <link rel="stylesheet" href="pure-min.css">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="side-menu-old-ie.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="side-menu.css">
    <!--<![endif]-->
    <!--[if lt IE 9]>
    <script src="html5shiv.js"></script>
    <![endif]-->
    <style>
        @media only screen and (min-width: 481px) {
            .form_button {
                text-align: center;
                margin-top: 1.5em;
            }

            .form_item {
                text-align: center;
            }
        }

        #overlay {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            background: #000;
            opacity: 0.8;
            filter: alpha(opacity=80);
        }

        #loading {
            width: 50px;
            height: 57px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -28px 0 0 -25px;
        }

        .service_type {
            display: none;
        }

        .service_type.service_type_ifttt {
            display: block;
        }

        .battery_interval {
            display: none;
        }

    </style>
    <script src="jquery-3.0.0.min.js"></script>
</head>
<body>
<div id="layout">
    <!-- Menu toggle -->
    <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
    </a>

    <div id="menu">
        <div class="pure-menu">
            <a class="pure-menu-heading">Justpresso</a>

            <ul class="pure-menu-list">
                <li class="pure-menu-item">
                    <a href="/" class="pure-menu-link">WiFi</a>
                </li>

                <li class="pure-menu-item pure-menu-selected">
                    <a href="justpresso.htm" class="pure-menu-link">Justpresso</a>
                </li>

                <li class="pure-menu-item">
                    <a href="update.htm" class="pure-menu-link">Update Firmware</a>
                </li>

                <li class="pure-menu-item">
                    <a href="ota.htm" class="pure-menu-link">OTA</a>
                </li>

                <li class="pure-menu-item">
                    <a href="contact.htm" class="pure-menu-link">Contact</a>
                </li>
            </ul>
        </div>
    </div>

    <div id="main">
        <div class="header">
            <h1>Justpresso Setup</h1>
            <h2>Setup Cloud Service</h2>
        </div>

        <div class="content">
            <div id="info_panel">
                <p>

                </p>
            </div>
            <h2 class="content-subhead">Justpresso configurations</h2>
            <!--<p>-->
            <!--Justpresso will use these configurations.-->
            <!--</p>-->

            <form class="pure-form pure-form-aligned" id="ssid_form" action="#" method="post">
                <fieldset>
                    <div class="pure-control-group">
                        <legend>Cloud Service</legend>
                        <div class="form_item">
                            <label for="service_IFTTT">IFTTT </label>
                            <input id="service_IFTTT" type="radio" name="service" value="IFTTT" checked>
                            <label for="service_REST">REST</label>
                            <input id="service_REST" type="radio" name="service" value="REST">
                            <label for="service_MQTT">MQTT</label>
                            <input id="service_MQTT" type="radio" name="service" value="MQTT">

                        </div>
                    </div>

                    <div class="pure-control-group service_type service_type_ifttt">
                        <legend>IFTTT</legend>
                        <div class="form_item">
                            <div>
                                <label for="ifttt_event">Event</label>
                                <input name="ifttt_event" id="ifttt_event" value="justpresso">
                                <label for="ifttt_key">Key</label>
                                <input id="ifttt_key" name="ifttt_key" value="XXX">
                            </div>
                        </div>
                    </div>

                    <div class="pure-control-group service_type service_type_rest">
                        <legend>REST</legend>
                        <div class="form_item">
                            <div>
                                <label for="rest_path">Path</label>
                                <input name="rest_path" id="rest_path" value="http://www.espert.io/MySmartphone/send">
                                <label for="rest_params">Params</label>
                                <input id="rest_params" name="rest_params" value="?key=XXX&message=Battery=:batt:%"/>
                            </div>
                        </div>
                    </div>

                    <div class="pure-control-group service_type service_type_mqtt">
                        <legend>MQTT</legend>
                        <div class="form_item">
                            <div>
                                <label for="mqtt_host">Host</label>
                                <input id="mqtt_host" name="mqtt_host" value="mqtt.espert.io">
                            </div>
                            <div>
                                <label for="mqtt_port">Port</label>
                                <input id="mqtt_port" name="mqtt_port" value="1883">
                            </div>
                            <div>
                                <label for="client_id">Client Id</label>
                                <input id="client_id" name="client_id" value="client_id">
                            </div>
                            <div>
                                <label for="mqtt_username">MQTT Username</label>
                                <input id="mqtt_username" name="mqtt_username" value="mqtt_username">
                            </div>
                            <div>
                                <label for="mqtt_password">MQTT Password</label>
                                <input id="mqtt_password" name="mqtt_password" value="mqtt_password">
                            </div>
                            <div>
                                <label for="mqtt_topic">MQTT Topic</label>
                                <input id="mqtt_topic" name="mqtt_topic" value="mqtt_topicd">
                            </div>
                            <div>
                                <label for="mqtt_message">MQTT Message</label>
                                <input id="mqtt_message" name="mqtt_message" value="mqtt_messagee">
                            </div>
                        </div>
                    </div>

                    <div class="pure-control-group service_type_battery">
                        <legend>Battery Service</legend>
                        <div class="form_item">
                            <div>
                                <label for="battery_path">Path</label>
                                <input name="battery_path" id="battery_path"
                                       value="http://api.thingspeak.com/update?api_key=DNKOIV7ETGO878JD&field1=:batt:&field2=:battRaw:">
                            </div>
                            <div class="battery_interval">
                                <label for="battery_interval"> Interval: </label>
                                <select id="battery_interval" name="battery_interval" class="battery_interval"
                                        style="width: auto;">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                    </div>


                    <div class="pure-control-group">
                        <legend>Wake-up Time</legend>
                        <div class="form_item">
                            <div>
                                <label for="hour"> hour: </label>
                                <select id="hour" name="hour" class="hour" style="width: auto;">
                                    <option value="0">00</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                </select>
                                <label for="minute"> minute: </label>
                                <select class="minute" id="minute" name="minute" style="width: auto;">
                                    <option value="0">00</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                    <option value="24">24</option>
                                    <option value="25">25</option>
                                    <option value="26">26</option>
                                    <option value="27">27</option>
                                    <option value="28">28</option>
                                    <option value="29">29</option>
                                    <option value="30">30</option>
                                    <option value="31">31</option>
                                    <option value="32">32</option>
                                    <option value="33">33</option>
                                    <option value="34">34</option>
                                    <option value="35">35</option>
                                    <option value="36">36</option>
                                    <option value="37">37</option>
                                    <option value="38">38</option>
                                    <option value="39">39</option>
                                    <option value="40">40</option>
                                    <option value="41">41</option>
                                    <option value="42">42</option>
                                    <option value="43">43</option>
                                    <option value="44">44</option>
                                    <option value="45">45</option>
                                    <option value="46">46</option>
                                    <option value="47">47</option>
                                    <option value="48">48</option>
                                    <option value="49">49</option>
                                    <option value="50">50</option>
                                    <option value="51">51</option>
                                    <option value="52">52</option>
                                    <option value="53">53</option>
                                    <option value="54">54</option>
                                    <option value="55">55</option>
                                    <option value="56">56</option>
                                    <option value="57">57</option>
                                    <option value="58">58</option>
                                    <option value="59">59</option>
                                </select>
                                <div class="unixtime"></div>
                            </div>
                        </div>
                    </div>


                    <div class="pure-control-group">
                        <legend>Hardware Status</legend>
                        <div class="pure-g">
                            <div class="pure-u-1-5"><span>Battery</span></div>
                            <div class="pure-u-1-5"><span id="ajax-battery">3200V</span></div>
                        </div>
                    </div>


                    <div class="pure-control-group">
                        <div class="form_button">
                            <button type="submit" class="pure-button pure-button-primary">Apply</button>
                            <button id="reset-button" type="submit" class="pure-button">Reboot</button>
                        </div>
                    </div>
                </fieldset>
            </form>
            <hr>
            <div id="version_panel">
            </div>
        </div>
    </div>
</div>
<div id="overlay" style='display:block;'>
    <img id="loading" src="loading.gif">
</div>

<script src="ui.js"></script>
<script>
    $(document).ready(function () {

        $.getJSON("/storage", function (data) {
            var selector;
            $.each(data, function (key, value) {
                if (key == "hour" || key == "minute") {
                    $('select[name=' + key + '] option[value=' + value + ']').prop('selected', true);
                }


                if (key == "service" && value != "") {
//                    $('select[name=' + key + '] option[value=' + value + ']').prop('selected', true);
                    $('input[value=' + value + ']:radio').prop('checked', true);
                    onServiceChanged();
                }

                selector = "input[name=" + key + "]";
                if (key != "service") {
                    if (value) {
                        $(selector).val(value);
                    }
                }
            });
        });

        $("#overlay").hide();


        $("#ssid_form").submit(function (e) {
            $("#overlay").show();
            var url = "/save"; // the script where you handle the form input.

            $.ajax({
                type: "POST",
                url: url,
                data: $("#ssid_form").serialize(), // serializes the form's elements.
                success: function (data) {
                    $("#overlay").hide();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $("#overlay").hide();
                    alert(xhr.responseText);
                    //alert(thrownError);
                }
            });

            e.preventDefault(); // avoid to execute the actual submit of the form.
        });


        setInterval(function () {
            $.getJSON("/batt", function (data) {
                $("#ajax-battery").text((data.batt / 1000).toFixed(3) + " V");
            });
        }, 500);

        var onServiceChanged = function (e) {
            var val = $("input[name=service]:checked").val();
            if (val == "MQTT") {
                $(".service_type").hide();
                $(".service_type_mqtt").show();
            }
            else if (val == "REST") {
                $(".service_type").hide();
                $(".service_type_rest").show();
            }
            else if (val == "IFTTT") {
                $(".service_type").hide();
                $(".service_type_ifttt").show();
            }
        };

        $("input[name=service]").change(function (e) {
            onServiceChanged(e);
        });
    });


    $("#reset-button").click(function (e) {
        $("#overlay").show();
        var r = confirm("Reboot the system to start with new config?");
        if (r == true) {
            $.get("/reboot", function () {
                $("#overlay").hide();
            });
        } else {
            e.preventDefault();
            return false;
        }
    });


</script>
</body>
</html>
