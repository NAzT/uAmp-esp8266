<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Justpresso Config Web Server">
    <title>Justpresso</title>
    <link rel="stylesheet" href="pure-min.css">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="side-menu-old-ie.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="side-menu.css">
    <!--<![endif]-->
    <!--[if lt IE 9]>
    <script src="html5shiv.js"></script>
    <![endif]-->
    <style>
        @media only screen and (min-width: 481px) {
            .form_button {
                text-align: center;
                margin-top: 1.5em;
            }

            .form_item {
                text-align: center;
            }
        }

        #overlay {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            background: #000;
            opacity: 0.8;
            filter: alpha(opacity=80);
        }

        #loading {
            width: 50px;
            height: 57px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -28px 0 0 -25px;
        }
    </style>
    <script src="jquery-3.0.0.min.js"></script>
</head>
<body>
<div id="layout">
    <!-- Menu toggle -->
    <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
    </a>

    <div id="menu">
        <div class="pure-menu">
            <a class="pure-menu-heading">Justpresso</a>

            <ul class="pure-menu-list">
                <li class="pure-menu-item pure-menu-selected">
                    <a href="#" class="pure-menu-link">WiFi</a>
                </li>

                <li class="pure-menu-item">
                    <a href="justpresso.htm" class="pure-menu-link">Justpresso</a>
                </li>

                <li class="pure-menu-item">
                    <a href="update.htm" class="pure-menu-link">Update Firmware</a>
                </li>

                <li class="pure-menu-item">
                    <a href="ota.htm" class="pure-menu-link">OTA</a>
                </li>

                <li class="pure-menu-item">
                    <a href="contact.htm" class="pure-menu-link">Contact</a>
                </li>
            </ul>
        </div>
    </div>

    <div id="main">
        <div class="header">
            <h1>WiFi Setup</h1>
            <h2>Setup your WiFi connection</h2>
        </div>

        <div class="content">
            <div id="info_panel">
                <p>

                </p>
            </div>
            <h2 class="content-subhead">Please setup your WiFi connection</h2>
            <p>
                Justpresso will update status of sensors and it's battery to the cloud via your WiFi connection.
                You can use cloud system to configure the action and notification for sensors and battery status.
                Please enter your Network Name (WiFi SSID) and password in the following form:
            </p>

            <form class="pure-form pure-form-aligned" id="ssid_form" action="#" method="post">
                <fieldset>
                    <div class="pure-control-group">
                        <div class="form_item">
                            <label for="ssid" style="width: 7em;">Network Name</label>
                            <!--<input id="ssid" name="ssid" type="text" placeholder="SSID">-->
                            <select id="ssid" name="ssid" style="width: 11.5em; align-items='left'; left:0px">
                            </select>
                        </div>
                    </div>

                    <div class="pure-control-group">
                        <div class="form_item">
                            <label for="password" style="width: 7em;">Password</label>
                            <input id="password" name="password" type="password" placeholder="Password">
                        </div>
                    </div>

                    <div class="pure-control-group">
                        <div class="form_button">
                            <label for="password" style="width: 0.5em;"></label>
                            <button type="submit" class="pure-button pure-button-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
            <hr>
            <div id="version_panel">
            </div>
        </div>
    </div>
</div>
<div id="overlay" style='display:block;'>
    <img id="loading" src="loading.gif">
</div>

<script src="ui.js"></script>
<script>
    $(document).ready(function () {
        $.getJSON('/scan', function (data) {
            var options = $("#ssid");
            options.empty();
            ssid_list = data['list'];
            $.each(ssid_list, function (i, obj) {
                options.append($("<option />").val(obj).text(obj));
                if (obj == data['current']) {
                    options.prop('selectedIndex', i);
                }
                else {
                }
            });
            if (data['ip'] != "0.0.0.0" && data['current'] != "" && data['ip'] != undefined) {
                $("#info_panel").html("<h4>Current WiFi Connection</h4><p>Network Name (SSID): " + data['current'] +
                        "<br>Device URL: <a href='http://" + data['ip'] + "/'>http://" +
                        data['ip'] + "/</a><br>IP Address: " + data["ip"] + "<hr>");
            }
            else {
                $("#info_panel").html("<h4>No WiFi Connection.</h4><hr>");
            }
            if (data['version']) {
                $("#version_panel").html("<small>Firmware version: " + data['version'] + " (SPIFFS " + data["spiffs"] + ")</small>");
            }
            $("#overlay").hide();
        })
                .fail(function (jqxhr) {
                    alert(jqxhr.responseText);
                });

        $("#ssid_form").submit(function (e) {
            $("#overlay").show();
            var url = "/ssid"; // the script where you handle the form input.

            $.ajax({
                type: "POST",
                url: url,
                data: $("#ssid_form").serialize(), // serializes the form's elements.
                success: function (data) {
                    $("#overlay").hide();
                    console.log(data);

                    //var json = $.parseJSON(data);
                    //console.log( json );
                    if (data['ip']) {
                        $("#info_panel").html("<h3><font color='blue'>WiFi Connection OK.</font></h3>" +
                                "<p>Network Name (SSID): " + data['current'] + "<br>Device URL: " +
                                "<a href='http://" + data['ip'] + "/'>http://" + data['ip'] + "/</a>" +
                                "<br>IP Address: " + data["ip"] + "<br><br>" +
                                "Click <a href='/reset'>RESET</a> to restart and connect WiFi<br><hr>");
                    }
                    else {
                        $("#info_panel").html("<h3><font color='red'>No WiFi Connection.</font></h3><hr>");
                    }
                    //alert(data['result']); // show response from the php script.
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $("#overlay").hide();
                    alert(xhr.responseText);
                    //alert(thrownError);
                }
            });

            e.preventDefault(); // avoid to execute the actual submit of the form.
        });
    })


</script>
</body>
</html>
